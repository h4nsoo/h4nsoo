name: Update Quote

on:
  schedule:
    # Runs every day at 00:00 UTC
    - cron: "0 0 * * *"
  workflow_dispatch: # Allows manual trigger

permissions:
  contents: write

jobs:
  update-quote:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Fetch and update quote
        run: |
          python3 << 'EOF'
          import requests
          import random
          import re
          import json

          # List of hardcoded inspiring quotes as fallback
          fallback_quotes = [
              '<i>"The only way to do great work is to love what you do." – Steve Jobs</i>',
              '<i>"Code is like humor. When you have to explain it, it\'s bad." – Cory House</i>',
              '<i>"First, solve the problem. Then, write the code." – John Johnson</i>',
              '<i>"Experience is the name everyone gives to their mistakes." – Oscar Wilde</i>',
              '<i>"In order to be irreplaceable, one must always be different." – Coco Chanel</i>',
              '<i>"The best way to predict the future is to invent it." – Alan Kay</i>',
              '<i>"Any fool can write code that a computer can understand. Good programmers write code that humans can understand." – Martin Fowler</i>',
              '<i>"Simplicity is the soul of efficiency." – Austin Freeman</i>',
              '<i>"Make it work, make it right, make it fast." – Kent Beck</i>',
              '<i>"Talk is cheap. Show me the code." – Linus Torvalds</i>'
          ]

          formatted_quote = None

          # Try ZenQuotes API (free, no auth required, reliable)
          try:
              response = requests.get('https://zenquotes.io/api/random', timeout=10, verify=True)
              response.raise_for_status()
              if response.text.strip():
                  data = response.json()
                  if data and len(data) > 0:
                      quote = data[0].get('q', '')
                      author = data[0].get('a', '')
                      if quote and author and len(quote) <= 200:
                          formatted_quote = f'<i>"{quote}" – {author}</i>'
                          print(f"Successfully fetched quote from ZenQuotes")
          except Exception as e:
              print(f"ZenQuotes API failed: {e}")

          # If ZenQuotes failed, try Quotable API with specific authors
          if not formatted_quote:
              try:
                  authors = ['albert-einstein', 'steve-jobs', 'oscar-wilde', 'mark-twain', 'alan-kay']
                  author_query = random.choice(authors)
                  response = requests.get(f'https://api.quotable.io/quotes?author={author_query}', timeout=10, verify=False)
                  response.raise_for_status()
                  data = response.json()
                  if data and 'results' in data and len(data['results']) > 0:
                      quote_obj = random.choice(data['results'])
                      quote = quote_obj.get('content', '')
                      author = quote_obj.get('author', '')
                      if quote and author and len(quote) <= 200:
                          formatted_quote = f'<i>"{quote}" – {author}</i>'
                          print(f"Successfully fetched quote from Quotable")
              except Exception as e:
                  print(f"Quotable API failed: {e}")

          # Use random fallback quote if all APIs failed
          if not formatted_quote:
              formatted_quote = random.choice(fallback_quotes)
              print(f"Using fallback quote")

          # Read README
          with open('README.md', 'r', encoding='utf-8') as f:
              content = f.read()

          # Replace quote between markers
          pattern = r'(<!-- QUOTE:START -->).*?(<!-- QUOTE:END -->)'
          replacement = f'\\1\n{formatted_quote}\n\\2'
          new_content = re.sub(pattern, replacement, content, flags=re.DOTALL)

          # Write back
          with open('README.md', 'w', encoding='utf-8') as f:
              f.write(new_content)

          print(f"Updated quote: {formatted_quote}")
          EOF

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update daily quote [skip ci]" && git push)
