name: Update Quote

on:
  schedule:
    # Runs every day at 00:00 UTC
    - cron: "0 0 * * *"
  workflow_dispatch: # Allows manual trigger

permissions:
  contents: write

jobs:
  update-quote:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Fetch and update quote
        run: |
          python3 << 'EOF'
          import requests
          import random
          import re
          import json

          # Randomly choose between anime and dev quotes
          if random.choice([0, 1]) == 0:
              # Fetch anime quote - using updated API
              try:
                  response = requests.get('https://animechan.io/api/v1/quotes/random', timeout=10)
                  response.raise_for_status()
                  if response.text.strip():
                      data = response.json()
                      # New API structure has 'data' wrapper
                      quote_data = data.get('data', data)
                      quote = quote_data.get('content', '')
                      character = quote_data.get('character', {}).get('name', '') if isinstance(quote_data.get('character'), dict) else quote_data.get('character', '')
                      anime = quote_data.get('anime', {}).get('name', '') if isinstance(quote_data.get('anime'), dict) else quote_data.get('anime', '')
                      if quote and character and anime:
                          formatted_quote = f'<i>"{quote}" – {character}, {anime}</i>'
                      else:
                          raise ValueError("Incomplete quote data")
                  else:
                      raise ValueError("Empty response")
              except Exception as e:
                  print(f"Error fetching anime quote: {e}")
                  # Fallback to dev quote on anime API failure
                  try:
                      response = requests.get('https://api.quotable.io/random?tags=technology,famous-quotes&maxLength=150', timeout=10)
                      response.raise_for_status()
                      data = response.json()
                      quote = data.get('content', '')
                      author = data.get('author', '')
                      if quote and author:
                          formatted_quote = f'<i>"{quote}" – {author}</i>'
                      else:
                          raise ValueError("Incomplete quote data")
                  except Exception as e2:
                      print(f"Error fetching fallback quote: {e2}")
                      formatted_quote = '<i>"The world is not beautiful, therefore it is." – Kino, Kino\'s Journey</i>'
          else:
              # Fetch dev quote - updated endpoint
              try:
                  response = requests.get('https://api.quotable.io/random?tags=technology,famous-quotes&maxLength=150', timeout=10)
                  response.raise_for_status()
                  if response.text.strip():
                      data = response.json()
                      quote = data.get('content', '')
                      author = data.get('author', '')
                      if quote and author:
                          formatted_quote = f'<i>"{quote}" – {author}</i>'
                      else:
                          raise ValueError("Incomplete quote data")
                  else:
                      raise ValueError("Empty response")
              except Exception as e:
                  print(f"Error fetching dev quote: {e}")
                  formatted_quote = '<i>"Code is like humor. When you have to explain it, it\'s bad." – Cory House</i>'

          # Read README
          with open('README.md', 'r', encoding='utf-8') as f:
              content = f.read()

          # Replace quote between markers
          pattern = r'(<!-- QUOTE:START -->).*?(<!-- QUOTE:END -->)'
          replacement = f'\\1\n{formatted_quote}\n\\2'
          new_content = re.sub(pattern, replacement, content, flags=re.DOTALL)

          # Write back
          with open('README.md', 'w', encoding='utf-8') as f:
              f.write(new_content)

          print(f"Updated quote: {formatted_quote}")
          EOF

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update daily quote [skip ci]" && git push)
