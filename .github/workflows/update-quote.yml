name: Update Quote

on:
  schedule:
    # Runs every day at 00:00 UTC
    - cron: "0 0 * * *"
  workflow_dispatch: # Allows manual trigger

jobs:
  update-quote:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Fetch and update quote
        run: |
          python3 << 'EOF'
          import requests
          import random
          import re

          # Randomly choose between anime and dev quotes
          if random.choice([0, 1]) == 0:
              # Fetch anime quote
              try:
                  response = requests.get('https://animechan.xyz/api/random', timeout=10)
                  data = response.json()
                  quote = data['quote']
                  character = data['character']
                  anime = data['anime']
                  formatted_quote = f'<i>"{quote}" – {character}, {anime}</i>'
              except Exception as e:
                  print(f"Error fetching anime quote: {e}")
                  formatted_quote = '<i>"The world is not beautiful, therefore it is." – Kino, Kino\'s Journey</i>'
          else:
              # Fetch dev quote
              try:
                  response = requests.get('https://api.quotable.io/quotes/random?tags=technology|famous-quotes&maxLength=150', timeout=10)
                  data = response.json()
                  quote = data[0]['content']
                  author = data[0]['author']
                  formatted_quote = f'<i>"{quote}" – {author}</i>'
              except Exception as e:
                  print(f"Error fetching dev quote: {e}")
                  formatted_quote = '<i>"Code is like humor. When you have to explain it, it\'s bad." – Cory House</i>'

          # Read README
          with open('README.md', 'r', encoding='utf-8') as f:
              content = f.read()

          # Replace quote between markers
          pattern = r'(<!-- QUOTE:START -->).*?(<!-- QUOTE:END -->)'
          replacement = f'\\1\n{formatted_quote}\n\\2'
          new_content = re.sub(pattern, replacement, content, flags=re.DOTALL)

          # Write back
          with open('README.md', 'w', encoding='utf-8') as f:
              f.write(new_content)

          print(f"Updated quote: {formatted_quote}")
          EOF

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update daily quote [skip ci]" && git push)
